<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardster Scoreboard</title>
    <style>
        /* Basic styles for TV display - customize as needed */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap');

        :root {
            --primary: #ff6600; /* Orange */
            --secondary: #00ccff; /* Cyan */
            --bg-dark: #0a0a0a;
            --bg-light: #1a1a1a; /* Used for inputs */
            --text: #ffffff;
            --success: #33cc33; /* Green */
            --danger: #ff3355; /* Red */
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure full height */
            text-align: center;
            padding: 3vh 3vw; /* Use viewport units for padding */
            box-sizing: border-box;
            position: relative; /* Needed for absolute positioning of video */
        }

        /* PIN Input Area Styles */
        #pin-entry-area {
            width: 90%;
            max-width: 400px;
            background-color: rgba(26, 26, 26, 0.9);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            z-index: 10; /* Ensure PIN entry is above potential video */
            position: relative;
            transition: opacity 0.5s ease, visibility 0s linear 0.5s; /* Fade out */
        }
        #pin-entry-area.hidden {
            /* Use opacity/visibility for smooth transitions */
            opacity: 0;
            visibility: hidden;
            /* Keep display:block/flex to allow transition */
            transition: opacity 0.5s ease, visibility 0s linear 0.5s;
        }
        #pin-entry-area label {
            display: block;
            color: var(--secondary);
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        #pin-input {
             background-color: var(--bg-light);
             color: white;
             border: 1px solid var(--secondary);
             padding: 15px;
             border-radius: 8px;
             width: 100%;
             margin-bottom: 20px;
             font-size: 1.5em; /* Larger font for PIN */
             text-align: center;
             letter-spacing: 5px; /* Space out digits */
             font-family: 'Orbitron', sans-serif; /* Match score font */
             outline: none;
             box-sizing: border-box;
        }
        /* Style for number input appearance */
        #pin-input[type=number]::-webkit-inner-spin-button,
        #pin-input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        #pin-input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }

        #load-scoreboard-btn {
             background: linear-gradient(135deg, var(--primary), var(--secondary));
             color: white;
             border: none;
             padding: 14px 28px;
             border-radius: 30px;
             font-size: 1em;
             font-weight: bold;
             cursor: pointer;
             transition: all 0.3s ease;
             text-transform: uppercase;
             letter-spacing: 1px;
             box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
             width: 100%;
        }
        #load-scoreboard-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
        }
        #load-scoreboard-btn:disabled {
             background: linear-gradient(135deg, #555, #777);
             cursor: not-allowed; opacity: 0.6; transform: none;
        }
        #pin-error-message {
            color: var(--danger);
            margin-top: 15px;
            font-weight: bold;
            min-height: 1.2em; /* Reserve space */
        }


        /* Scoreboard Content Area Styles */
        #scoreboard-content {
            width: 95%;
            max-width: 1000px;
            background-color: rgba(26, 26, 26, 0.9);
            padding: 3vh 3vw; /* Reduced padding slightly */
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 90vh; /* Limit height */
            z-index: 10; /* Above video by default */
            position: relative;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease, visibility 0s linear 0s; /* Fade in/out */
        }
        #scoreboard-content.hidden {
            /* Use opacity/visibility for transitions */
            opacity: 0;
            visibility: hidden;
            /* Keep display:flex to allow transition */
             display: flex !important;
            transition: opacity 0.5s ease, visibility 0s linear 0.5s;
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary);
            font-size: clamp(2.2em, 5vw, 4em); /* Adjusted font size */
            margin-bottom: 2vh; /* Reduced margin */
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            width: 100%;
        }

        /* Current PIN Display */
        #current-pin-display {
            font-size: clamp(0.8em, 1.5vw, 1em);
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 2vh;
        }
        #current-pin-display span {
             font-weight: bold;
             color: var(--secondary);
             margin-left: 5px;
        }

        /* Overlay Shot Message Styling */
        #overlay-shot-message {
            position: fixed;
            top: 3vh; /* Position from top */
            left: 50%;
            transform: translateX(-50%);
            z-index: 100; /* High z-index to be above video and scoreboard */
            background-color: rgba(255, 102, 0, 0.85); /* More opaque background */
            color: white; /* White text for better contrast */
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px 30px;
            font-size: clamp(1.5em, 4vw, 2.5em); /* Prominent font size */
            font-weight: bold;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            max-width: 80%;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease, visibility 0s linear 0s;
            /* Use inline-block for sizing based on content */
            display: inline-block !important;
        }
        #overlay-shot-message.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0s linear 0.4s;
        }


        /* Score Columns Container */
        #score-columns-container {
            display: flex;
            justify-content: space-around; /* Distribute space between columns */
            width: 100%;
            gap: 3vw; /* Gap between columns */
            margin-bottom: 3vh; /* Space below scores */
        }
        /* Use visibility toggle for container as well if needed, or manage via content */
        /* #score-columns-container.hidden { display: none; } */

        /* Individual Score Column */
        .score-column {
             width: 48%; /* Each column takes slightly less than half */
             list-style: none;
             padding: 0;
             margin: 0;
        }

        /* Score List Item */
        li.player-item {
            display: flex;
            align-items: center;
            font-size: clamp(1.8em, 4vw, 3em); /* INCREASED FONT SIZE */
            padding: 12px 5px; /* Adjusted padding slightly */
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text);
        }
         li.player-item:last-child {
             border-bottom: none;
         }

        /* Player Face in Scoreboard - Significantly larger */
        .player-face-img {
            width: 100px; /* INCREASED SIZE */
            height: 100px; /* INCREASED SIZE */
            border-radius: 50%;
            margin-right: 20px; /* INCREASED SPACE */
            flex-shrink: 0;
            background-color: var(--bg-light); /* Placeholder bg */
            border: 3px solid var(--secondary); /* INCREASED BORDER */
            background-size: cover;
            background-position: center;
            display: inline-block;
             /* Default Icon using background-image */
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cccccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
             background-repeat: no-repeat;
             background-size: 70%; /* Adjusted SVG icon size */
             object-fit: cover; /* Ensure loaded images cover the area */
        }

        .player-info-wrapper {
             display: flex;
             align-items: center;
             flex-grow: 1; /* Takes up space pushing score to the right */
             overflow: hidden; /* Prevents long names from breaking layout */
             min-width: 0; /* Important for flex item overflow */
        }

        .player-name {
            color: var(--secondary);
            text-align: left;
            margin-right: 20px; /* INCREASED SPACE */
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 1; /* Allow name to shrink if needed */
        }
        .player-score {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            min-width: 80px; /* INCREASED MIN-WIDTH */
            text-align: right;
            color: var(--primary);
            flex-shrink: 0; /* Prevent score from shrinking */
        }

        /* Winner Display - Adjusted for 16:9 */
        #winner-display {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2.5em, 6vw, 4.5em); /* INCREASED FONT */
            color: var(--success);
            margin-top: 4vh; /* Adjusted margin */
            font-weight: bold;
            line-height: 1.3;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2vh; /* Adjusted gap */
        }
        /* Use class for hiding */
        /* #winner-display.hidden { display: none; } */

        /* Winner Face Image - Larger */
        #winner-face-img {
             width: clamp(150px, 25vw, 250px); /* INCREASED SIZE */
             height: clamp(150px, 25vw, 250px); /* INCREASED SIZE */
             border-radius: 50%;
             border: 5px solid var(--success); /* INCREASED BORDER */
             background-color: var(--bg-light); /* Placeholder */
             background-size: cover;
             background-position: center;
             /* Default Icon via background-image (optional, if src fails) */
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cccccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
             background-repeat: no-repeat;
             background-size: 70%; /* Adjusted SVG size */
             object-fit: cover; /* Ensure loaded image covers */
             /* Display handled by JS */
             /* display: none; */
        }
        /* Use class for hiding */
        /* #winner-face-img.hidden { display: none; } */

         #winner-text {
             text-align: center;
         }
         #winner-name-text {
              display: block;
              margin-bottom: 5px;
              color: var(--success); /* Ensure winner name is green */
         }
         #winner-reward-text {
              font-size: 0.6em; /* Relative to winner name size */
              font-weight: normal;
              color: var(--text); /* White reward text */
              display: block;
         }

        #status-message {
            font-size: clamp(1.2em, 2.5vw, 1.8em); /* Adjusted font size */
            color: rgba(255, 255, 255, 0.7);
            width: 100%;
            text-align: center;
            padding: 20px 0;
            /* Displayed within the main content area */
            margin-top: 2vh;
            /* Display handled by JS */
            /* display: none; */
        }
        /* Use class for hiding */
        /* #status-message.hidden { display: none; } */

        /* ++ VIDEO STYLES ++ */
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Darker overlay */
            display: flex; /* Use flex for centering */
            align-items: center;
            justify-content: center;
            z-index: 50; /* Above scoreboard content, below overlay shot message */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.6s ease-in-out, visibility 0s linear 0.6s;
        }
        #video-container.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.6s ease-in-out, visibility 0s linear 0s;
            /* z-index remains 50 */
        }
        #youtube-player {
            width: 80vw; /* Adjust size as needed */
            height: 45vw; /* Maintain 16:9 aspect ratio */
            max-width: 1280px;
            max-height: 720px;
            border: 2px solid var(--secondary);
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.5);
        }
        /* ++ END VIDEO STYLES ++ */

        /* Generic hidden utility class */
        .hidden {
            display: none !important;
        }
        /* Override for elements controlled by opacity/visibility */
        #scoreboard-content.hidden,
        #pin-entry-area.hidden,
        #overlay-shot-message.hidden {
            /* Keep in layout for opacity transition */
            display: flex !important; /* Or block/inline-block as appropriate */
            opacity: 0 !important;
            visibility: hidden !important;
        }
        /* Adjust display types for specific transitioning elements */
        #pin-entry-area { display: block !important; } /* Was block */
        #pin-entry-area.hidden { display: block !important; opacity: 0 !important; visibility: hidden !important; }
        #scoreboard-content { display: flex !important; } /* Was flex */
        #scoreboard-content.hidden { display: flex !important; opacity: 0 !important; visibility: hidden !important; }
        #overlay-shot-message { display: inline-block !important; } /* Was inline-block */
        #overlay-shot-message.hidden { display: inline-block !important; opacity: 0 !important; visibility: hidden !important; }

        /* Ensure video container is correctly handled by its 'visible' class */
        #video-container { display: flex !important; } /* Keep flex for centering */
        #video-container:not(.visible) {
            /* Use opacity/visibility for hiding, not display:none */
            opacity: 0 !important;
            visibility: hidden !important;
        }

    </style>
</head>
<body>

    <!-- PIN Entry Area (Shown Initially) -->
    <div id="pin-entry-area">
        <label for="pin-input">Enter Game PIN:</label>
        <input type="number" id="pin-input" pattern="\d{4}" title="4-digit PIN" maxlength="4" inputmode="numeric">
        <button id="load-scoreboard-btn">Load Scoreboard</button>
        <div id="pin-error-message"></div>
    </div>

    <!-- Overlay Shot Message (Starts Hidden via CSS) -->
    <div id="overlay-shot-message" class="hidden"></div>

    <!-- Scoreboard Content Area (Hidden Initially via CSS) -->
    <div id="scoreboard-content" class="hidden">
        <h1>Hardster Scores</h1>
        <div id="current-pin-display" class="hidden">Viewing PIN: <span id="viewing-pin"></span></div>

        <!-- Score Columns Container -->
        <div id="score-columns-container" class="hidden"> <!-- Start hidden, shown by JS -->
            <ul id="score-column-1" class="score-column">
                <!-- Player items added dynamically -->
            </ul>
            <ul id="score-column-2" class="score-column">
                <!-- Player items added dynamically -->
            </ul>
        </div>

         <!-- Status message -->
         <div id="status-message" class="hidden">Connecting...</div>


        <!-- Winner Display Area -->
        <div id="winner-display" class="hidden"> <!-- Start hidden, shown by JS -->
            <img id="winner-face-img" src="" alt="Winner Face" class="hidden"> <!-- Use <img> tag -->
            <div id="winner-text">
                 <span id="winner-name-text"></span>
                 <span id="winner-reward-text"></span>
            </div>
        </div>
    </div>

    <!-- Video Container (Starts hidden via CSS opacity/visibility) -->
    <div id="video-container">
        <div id="youtube-player"></div>
    </div>


    <!-- Firebase SDKs (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          // IMPORTANT: Replace with your actual Firebase config
          apiKey: "AIzaSyD0nnCDuG_4ymWoWk5AKYaXwnl4nWkVi9s", // USE YOUR CONFIG
          authDomain: "hardster-7e2c5.firebaseapp.com",
          databaseURL: "https://hardster-7e2c5-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "hardster-7e2c5",
          storageBucket: "hardster-7e2c5.appspot.com",
          messagingSenderId: "667886748380",
          appId: "1:667886748380:web:38b2c60e14158d16ae2a19",
        };
        const FIREBASE_ROOT_PATH = 'hardster/games'; // Root path in RTDB for games
        const MAX_DISPLAY_PLAYERS = 8; // Max players to show in columns

        // --- DOM Elements ---
        const pinEntryArea = document.getElementById('pin-entry-area');
        const pinInput = document.getElementById('pin-input');
        const loadButton = document.getElementById('load-scoreboard-btn');
        const pinErrorMessage = document.getElementById('pin-error-message');
        const scoreboardContent = document.getElementById('scoreboard-content');
        const viewingPinEl = document.getElementById('viewing-pin');
        const currentPinDisplay = document.getElementById('current-pin-display');
        const overlayShotMessageEl = document.getElementById('overlay-shot-message');
        const scoreColumnsContainer = document.getElementById('score-columns-container');
        const scoreColumn1 = document.getElementById('score-column-1');
        const scoreColumn2 = document.getElementById('score-column-2');
        const statusMessageEl = document.getElementById('status-message');
        const winnerDisplayEl = document.getElementById('winner-display');
        const winnerNameTextEl = document.getElementById('winner-name-text');
        const winnerRewardTextEl = document.getElementById('winner-reward-text');
        const winnerFaceImgEl = document.getElementById('winner-face-img'); // Now an <img> tag
        const videoContainer = document.getElementById('video-container');
        const youtubePlayerDiv = document.getElementById('youtube-player');

        // --- State ---
        let firebaseApp;
        let dbRef = null; // Firebase database reference for the current game PIN
        let currentPIN = null; // The currently active game PIN
        let listenerAttached = false; // Flag to track if Firebase listener is active
        let youtubePlayer = null; // YouTube player instance
        // Track the last known state received from Firebase to avoid redundant updates
        let lastReceivedState = {
            videoId: null,
            showVideo: false,
            isPlaying: false, // Spotify playback state (used for YT sync)
            shotMessage: null,
            isGameOver: false,
            players: [],
            winnerName: null,
            winnerFaceDataUrl: null
        };
        let isVideoCurrentlyVisible = false; // Track if the video container *is* currently rendered visibly

        // --- Firebase Initialization ---
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log("Firebase app initialized for scoreboard display.");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            pinErrorMessage.textContent = 'Error connecting to Firebase service.';
            loadButton.disabled = true;
        }

        // --- YouTube Player API Setup ---

        /**
         * Called by the YouTube IFrame API script when it's ready.
         * Creates the YT.Player instance.
         */
        function onYouTubeIframeAPIReady() {
            console.log("YouTube IFrame API Ready");
            try {
                youtubePlayer = new YT.Player('youtube-player', {
                    height: '100%', // Fill the container div
                    width: '100%',  // Fill the container div
                    playerVars: {
                        'playsinline': 1,       // iOS inline playback
                        'autoplay': 1,          // Autoplay when loaded
                        'controls': 0,          // Hide native controls
                        'modestbranding': 1,    // Less YouTube logo
                        'rel': 0,               // Don't show related videos
                        'iv_load_policy': 3,    // Don't show annotations
                        'showinfo': 0           // Hide title (deprecated, but good practice)
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });
            } catch (e) {
                console.error("Error creating YouTube player instance:", e);
                statusMessageEl.textContent = "Error initializing video player.";
                statusMessageEl.classList.remove('hidden');
            }
        }

        /**
         * Called when the YouTube player instance is ready.
         * Mutes the player and loads video if needed based on initial Firebase state.
         */
        function onPlayerReady(event) {
            console.log("YouTube Player Ready");
            // Ensure player is muted by default
            event.target.mute();
            console.log("Player muted.");

            // Check if Firebase already indicated a video should be shown *before* the player was ready
            const shouldShowInitialVideo = lastReceivedState.showVideo && lastReceivedState.videoId && !lastReceivedState.isGameOver;
            if (shouldShowInitialVideo) {
                 console.log("Player ready, loading video based on last received state:", lastReceivedState.videoId);
                 // Directly call loadAndPlayVideo to handle visibility and loading
                 loadAndPlayVideo(lastReceivedState.videoId);
                 // Also immediately sync pause/play state if needed
                 syncVideoPlaybackState(lastReceivedState.isPlaying);
            }
        }

        /**
         * Called when the YouTube player's state changes (playing, paused, ended, etc.).
         * Primarily used here to re-mute if needed (sometimes autoplay might unmute briefly).
         */
        function onPlayerStateChange(event) {
             if (event.data === YT.PlayerState.PLAYING) {
                 // Ensure it's muted whenever it enters the playing state
                 if (youtubePlayer && typeof youtubePlayer.mute === 'function' && !youtubePlayer.isMuted()) {
                     youtubePlayer.mute();
                     console.log("Re-muted player on state change to PLAYING.");
                 }
             } else if (event.data === YT.PlayerState.ENDED) {
                console.log("Video finished playing.");
                // Optional: Automatically hide video when finished?
                // hideVideo();
                // updateDisplay() driven by Firebase will handle scoreboard visibility
             }
        }

        /**
         * Called when a YouTube player error occurs.
         * Hides the video player and shows an error message on the scoreboard.
         */
        function onPlayerError(event) {
            console.error("YouTube Player Error:", event.data);
            // Hide the player on error to show the scoreboard
            hideVideo();
            statusMessageEl.textContent = `Video Error (${event.data}). Scoreboard shown.`;
            statusMessageEl.classList.remove('hidden');
            scoreboardContent.classList.remove('hidden'); // Ensure scoreboard content is visible
        }

        /**
         * Loads a video by ID and makes the video container visible.
         * Hides the scoreboard content.
         * @param {string} videoId - The YouTube video ID to load.
         */
        function loadAndPlayVideo(videoId) {
            if (!youtubePlayer || typeof youtubePlayer.loadVideoById !== 'function') {
                 console.warn("YouTube player not ready or invalid, cannot load video.");
                 // Ensure scoreboard is visible if video can't load/play
                 scoreboardContent.classList.remove('hidden');
                 hideVideo(); // Ensure video container is hidden
                 return;
            }

            // Only load if the video ID is different OR if the container wasn't visible before
            if (lastReceivedState.videoId !== videoId || !isVideoCurrentlyVisible) {
                console.log(`Showing video container and loading video: ${videoId}`);
                scoreboardContent.classList.add('hidden'); // Hide scoreboard content
                videoContainer.classList.add('visible'); // Start fading in video overlay
                isVideoCurrentlyVisible = true;
                youtubePlayer.loadVideoById(videoId); // API call to load and autoplay (due to playerVars)
                // Muting is handled in onReady/onStateChange
            } else {
                console.log("Video ID is the same and container already visible. Ensuring playback state.");
                // If ID is same but container already visible, just ensure playback state matches Firebase
                syncVideoPlaybackState(lastReceivedState.isPlaying);
            }
        }

        /**
         * Hides the video container and stops the video playback.
         * Makes the scoreboard content visible again.
         */
        function hideVideo() {
            // Only act if the video container IS currently visible
            if (isVideoCurrentlyVisible) {
                console.log("Hiding video player.");
                videoContainer.classList.remove('visible'); // Start fading out video overlay
                isVideoCurrentlyVisible = false;

                // Stop video playback shortly after fade out starts
                if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') {
                     setTimeout(() => {
                        // Double check it should still be hidden before stopping
                        if (!isVideoCurrentlyVisible && youtubePlayer.getPlayerState && youtubePlayer.getPlayerState() !== YT.PlayerState.ENDED) {
                            youtubePlayer.stopVideo();
                            console.log("Video stopped.");
                        }
                     }, 600); // Match CSS transition duration
                }
                // Ensure scoreboard content becomes visible again immediately as video fades out
                scoreboardContent.classList.remove('hidden');
            } else {
                // If hideVideo is called but it's already hidden, ensure scoreboard is visible anyway
                scoreboardContent.classList.remove('hidden');
            }
            // We don't clear lastReceivedState.videoId here, as it's useful for comparison
        }

        /**
         * Syncs the YouTube player's play/pause state with the desired state (from Spotify via Firebase).
         * Only acts if the player exists and the video container is currently visible.
         * @param {boolean} shouldBePlaying - True if the video should be playing, false if paused.
         */
        function syncVideoPlaybackState(shouldBePlaying) {
             if (youtubePlayer && isVideoCurrentlyVisible && typeof youtubePlayer.getPlayerState === 'function') {
                 const playerState = youtubePlayer.getPlayerState();
                 // YT.PlayerState: -1 (unstarted), 0 (ended), 1 (playing), 2 (paused), 3 (buffering), 5 (video cued)

                 if (shouldBePlaying && playerState !== YT.PlayerState.PLAYING && playerState !== YT.PlayerState.BUFFERING) {
                     console.log(`Sync: Telling YouTube player to PLAY (Current State: ${playerState})`);
                     youtubePlayer.playVideo();
                 } else if (!shouldBePlaying && playerState === YT.PlayerState.PLAYING) {
                     console.log(`Sync: Telling YouTube player to PAUSE (Current State: ${playerState})`);
                     youtubePlayer.pauseVideo();
                 }
             }
        }
        // --- END YouTube ---


        // --- Event Listeners ---
        loadButton.addEventListener('click', handleLoadScoreboard);
        pinInput.addEventListener('keypress', (e) => {
            // Allow Enter key to submit
            if (e.key === 'Enter') { handleLoadScoreboard(); }
            // Allow only digits and essential navigation/edit keys
            if (!/\d/.test(e.key) && !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter'].includes(e.key)) {
                 e.preventDefault();
            }
        });
        pinInput.addEventListener('input', () => {
            pinErrorMessage.textContent = ''; // Clear error on input
            // Enforce max length
            if (pinInput.value.length > 4) { pinInput.value = pinInput.value.slice(0, 4); }
            // Enable button only when exactly 4 digits are entered
            loadButton.disabled = pinInput.value.length !== 4;
        });


        // --- Core Functions ---

        /**
         * Handles the click on the "Load Scoreboard" button.
         * Validates the PIN, detaches previous Firebase listener, attaches a new one.
         * Updates the UI to show the scoreboard area (initially in loading state).
         */
        function handleLoadScoreboard() {
            const enteredPin = pinInput.value.trim();
            if (enteredPin.length !== 4 || !/^\d{4}$/.test(enteredPin)) {
                pinErrorMessage.textContent = 'Please enter a valid 4-digit PIN.';
                return;
            }
            if (!firebaseApp) {
                pinErrorMessage.textContent = 'Firebase connection failed. Cannot load.';
                return;
            }

            pinErrorMessage.textContent = '';
            loadButton.disabled = true;
            loadButton.textContent = 'Loading...';

            // Detach previous listener if it exists and is attached
            if (dbRef && listenerAttached) {
                dbRef.off('value');
                listenerAttached = false;
                console.log("Detached previous Firebase listener.");
            }

            currentPIN = enteredPin;
            try {
                 // Set the database reference to the specific game PIN path
                 dbRef = firebase.database().ref(`${FIREBASE_ROOT_PATH}/${currentPIN}`);
                 console.log("Attempting to listen at:", dbRef.toString());

                 // Attach the listener for data updates
                 listenForUpdates();

                 // Update UI: Hide PIN entry, show scoreboard (loading state)
                 pinEntryArea.classList.add('hidden');
                 scoreboardContent.classList.remove('hidden'); // Show scoreboard container
                 statusMessageEl.textContent = 'Loading scores...';
                 statusMessageEl.classList.remove('hidden');
                 scoreColumnsContainer.classList.add('hidden'); // Hide columns until data loads
                 winnerDisplayEl.classList.add('hidden');       // Hide winner display
                 overlayShotMessageEl.classList.add('hidden'); // Hide overlay message
                 viewingPinEl.textContent = currentPIN;
                 currentPinDisplay.classList.remove('hidden');
                 hideVideo(); // Ensure video is hidden when loading a new PIN

             } catch(e) {
                 console.error("Error setting Firebase path or attaching listener:", e);
                 pinErrorMessage.textContent = 'Error accessing game data. Check PIN?';
                 loadButton.disabled = false; // Re-enable button on error
                 loadButton.textContent = 'Load Scoreboard';
                 scoreboardContent.classList.add('hidden'); // Hide scoreboard area
                 pinEntryArea.classList.remove('hidden');    // Show PIN entry again
                 hideVideo(); // Ensure video hidden on error too
             }
        }


        /**
         * Attaches the Firebase 'value' listener to the current dbRef.
         * Handles incoming data updates and errors.
         */
        function listenForUpdates() {
            if (!dbRef) {
                console.error("Cannot listen for updates: Firebase dbRef is not set.");
                return;
            }

            listenerAttached = true; // Mark listener as active before attaching

            dbRef.on('value', (snapshot) => {
                // Successfully received data
                const data = snapshot.val();
                // console.log("Received Firebase update:", data); // Optional: Log all updates
                updateDisplay(data); // Process and display the data

                // Reset loading button state (might have been disabled during PIN entry)
                // It's okay if this runs even if PIN entry isn't visible
                loadButton.textContent = 'Load Scoreboard';
                loadButton.disabled = pinInput.value.length !== 4;

            }, (error) => {
                // Error occurred while listening
                console.error("Firebase read failed:", error);
                listenerAttached = false; // Mark listener as inactive due to error

                // Clear scoreboard content
                scoreColumn1.innerHTML = '';
                scoreColumn2.innerHTML = '';
                winnerDisplayEl.classList.add('hidden');
                overlayShotMessageEl.classList.add('hidden');
                scoreColumnsContainer.classList.add('hidden');

                // Show error message in the status area
                statusMessageEl.textContent = `Error loading scores for PIN ${currentPIN}. Is the game active or PIN correct?`;
                statusMessageEl.classList.remove('hidden');
                scoreboardContent.classList.remove('hidden'); // Ensure scoreboard area is visible to show error
                hideVideo(); // Hide video on error

                // Optionally allow user to try again or enter new PIN
                pinEntryArea.classList.remove('hidden'); // Show PIN entry
                loadButton.disabled = false; // Re-enable button
            });
        }

        /**
         * Updates the entire scoreboard display based on the data received from Firebase.
         * Handles showing/hiding video, overlay messages, scores, and winner info.
         * @param {object|null} data - The data snapshot value from Firebase for the game PIN.
         */
        function updateDisplay(data) {
            // --- 1. Process incoming data and derive state ---
            const incomingState = {
                videoId: data?.currentVideoId || null,
                showVideo: data?.showVideo === true,
                isPlaying: data?.isPlaying === true, // Spotify playback state
                shotMessage: data?.shotMessage || null,
                isGameOver: data?.isGameOver === true,
                players: data?.players || [], // Ensure players is always an array
                winnerName: data?.winnerName || null,
                winnerFaceDataUrl: data?.winnerFaceDataUrl || null
            };
            // console.log("Incoming State:", incomingState);
            // console.log("Last Received State:", lastReceivedState);
            // console.log("Is Video Currently Visible:", isVideoCurrentlyVisible);

            // Determine if video *should* be displayed based on current state
            const shouldShowVideo = incomingState.showVideo && incomingState.videoId && !incomingState.isGameOver;


            // --- 2. Handle Overlay Shot Message (Highest Priority Display Element) ---
            // Show shot message only if it exists AND the game is NOT over
            if (incomingState.shotMessage && !incomingState.isGameOver) {
                overlayShotMessageEl.textContent = escapeHTML(incomingState.shotMessage);
                overlayShotMessageEl.classList.remove('hidden');
            } else {
                overlayShotMessageEl.classList.add('hidden');
            }


            // --- 3. Handle Video Display Logic ---
            const videoIdChanged = incomingState.videoId !== lastReceivedState.videoId;
            const showStateChanged = shouldShowVideo !== (lastReceivedState.showVideo && lastReceivedState.videoId && !lastReceivedState.isGameOver); // Compare effective show state

            if (shouldShowVideo) {
                // Condition: Video should be showing
                if (videoIdChanged || showStateChanged || !isVideoCurrentlyVisible) {
                    // Load/Reload if:
                    // - Video ID changed
                    // - The *effective* show state changed from false to true
                    // - The video container is not currently visible (e.g., after an error)
                    loadAndPlayVideo(incomingState.videoId); // Handles showing container & hiding scoreboard
                }
                // Always sync playback state if video is supposed to be showing
                syncVideoPlaybackState(incomingState.isPlaying);

            } else {
                // Condition: Video should NOT be showing
                if (isVideoCurrentlyVisible) {
                    // Only hide if it's currently visible to trigger transition/stop
                    hideVideo(); // Handles hiding container & showing scoreboard
                } else {
                    // Ensure scoreboard is visible if video isn't meant to show AND isn't already visible
                    // This covers cases like initial load or state after video error.
                    scoreboardContent.classList.remove('hidden');
                }
            }

            // Sync playback state again (redundant if called above, but safe)
            // This ensures pause state is correct even if video wasn't reloaded.
            // syncVideoPlaybackState(incomingState.isPlaying); // Covered in the 'shouldShowVideo' block


            // --- 4. Update Scoreboard Content (Scores, Winner, Status) ---
            // This runs regardless of video visibility, but the #scoreboard-content div itself might be hidden

            // Clear previous content first
            scoreColumn1.innerHTML = '';
            scoreColumn2.innerHTML = '';
            winnerDisplayEl.classList.add('hidden');
            statusMessageEl.classList.add('hidden');
            scoreColumnsContainer.classList.add('hidden'); // Hide columns by default

            if (!data) {
                 // No data found for this PIN
                 statusMessageEl.textContent = `Waiting for game data for PIN ${currentPIN}...`;
                 statusMessageEl.classList.remove('hidden');
            } else if (incomingState.isGameOver && incomingState.winnerName) {
                 // --- Display Winner Information ---
                 winnerNameTextEl.textContent = escapeHTML(incomingState.winnerName);
                 // Calculate reward based on player count (matches index.html logic)
                 const shots = (incomingState.players.length >= 5 ? 2 : 1);
                 winnerRewardTextEl.textContent = `mag ${shots} shot${shots > 1 ? 's' : ''} uitdelen!`;

                 // Handle winner face image
                 winnerFaceImgEl.src = ''; // Clear previous src
                 winnerFaceImgEl.style.backgroundImage = ''; // Clear potential default icon BG
                 winnerFaceImgEl.classList.add('hidden'); // Hide initially

                 if (incomingState.winnerFaceDataUrl) {
                     winnerFaceImgEl.src = incomingState.winnerFaceDataUrl; // Set src to Data URL
                     winnerFaceImgEl.alt = `Winner: ${escapeHTML(incomingState.winnerName)}`;
                     winnerFaceImgEl.onerror = () => { // Fallback if Data URL fails to load
                         console.warn("Winner face Data URL failed to load, using default icon.");
                         winnerFaceImgEl.src = ''; // Clear broken src
                         winnerFaceImgEl.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cccccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>')`;
                     };
                     winnerFaceImgEl.classList.remove('hidden'); // Show image element
                 } else {
                     // Use default SVG icon directly via background-image if no face URL provided
                     winnerFaceImgEl.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cccccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>')`;
                     winnerFaceImgEl.alt = 'Winner (no face image)';
                     winnerFaceImgEl.classList.remove('hidden'); // Show image element (displaying background SVG)
                 }
                 winnerDisplayEl.classList.remove('hidden'); // Show the winner section

             } else if (incomingState.players && incomingState.players.length > 0) {
                 // --- Display Player Scores ---
                 scoreColumnsContainer.classList.remove('hidden'); // Show columns container

                 // Sort players by score descending for display
                 const sortedPlayers = [...incomingState.players].sort((a, b) => b.score - a.score);

                 sortedPlayers.slice(0, MAX_DISPLAY_PLAYERS).forEach((player, index) => {
                     const li = document.createElement('li');
                     li.className = 'player-item';

                     // Player Face Image (using <img> tag for better semantics/loading)
                     const faceImg = document.createElement('img');
                     faceImg.className = 'player-face-img';
                     faceImg.src = ''; // Clear previous src
                     faceImg.style.backgroundImage = ''; // Clear potential default icon BG
                     faceImg.alt = `${escapeHTML(player.name)} face`;

                     if (player.faceDataUrl) {
                         faceImg.src = player.faceDataUrl;
                         faceImg.onerror = () => { // Fallback if Data URL fails
                            console.warn(`Player face Data URL failed for ${player.name}, using default.`);
                            faceImg.src = '';
                            faceImg.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cccccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>')`;
                         };
                     } else {
                         // Use default icon background if no URL
                         faceImg.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cccccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>')`;
                     }

                     // Player Name and Score elements
                     const nameSpan = document.createElement('span');
                     nameSpan.className = 'player-name';
                     nameSpan.textContent = escapeHTML(player.name);

                     const scoreSpan = document.createElement('span');
                     scoreSpan.className = 'player-score';
                     scoreSpan.textContent = player.score;

                     // Wrapper for flex layout
                     const infoWrapper = document.createElement('div');
                     infoWrapper.className = 'player-info-wrapper';
                     infoWrapper.appendChild(faceImg);
                     infoWrapper.appendChild(nameSpan);

                     li.appendChild(infoWrapper);
                     li.appendChild(scoreSpan);

                     // Distribute players into two columns
                     if (index % 2 === 0) {
                         scoreColumn1.appendChild(li);
                     } else {
                         scoreColumn2.appendChild(li);
                     }
                 });

                 // If after processing, both columns are still empty (e.g., MAX_DISPLAY_PLAYERS was 0)
                 if (scoreColumn1.children.length === 0 && scoreColumn2.children.length === 0) {
                     statusMessageEl.textContent = 'No players to display...';
                     statusMessageEl.classList.remove('hidden');
                     scoreColumnsContainer.classList.add('hidden'); // Hide columns container again
                 }

             } else {
                  // Data exists, but no players array or it's empty
                  statusMessageEl.textContent = 'Waiting for players to join...';
                  statusMessageEl.classList.remove('hidden');
             }

            // --- 5. Update last known state ---
            // Store the processed state to compare against the next update
            lastReceivedState = { ...incomingState };

        } // --- End updateDisplay Function ---

        // --- Utility Functions ---

        /**
         * Basic HTML escaping function to prevent XSS from player names or messages.
         * @param {string | null | undefined} str - The string to escape.
         * @returns {string} The escaped string.
         */
         function escapeHTML(str) {
             if (str === null || str === undefined) return '';
             return String(str)
                 .replace(/&/g, '&')
                 .replace(/</g, '<')
                 .replace(/>/g, '>')
                 .replace(/"/g, '"')
                 .replace(/'/g, ''');
         }

         // --- Initial Setup ---
         // Disable load button initially until 4 digits are entered
         loadButton.disabled = true;
         // Initial hiding of elements is handled by CSS classes and styles

    </script>
</body>
</html>
