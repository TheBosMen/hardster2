<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardster Scoreboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap');
        :root {
            --primary: #f60; /* Orange */
            --secondary: #0cf; /* Cyan */
            --bg-dark: #0a0a0a;
            --bg-light: #1a1a1a;
            --text: #fff;
            --success: #3c3; /* Green */
            --danger: #f35; /* Red */
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            background-color: var(--bg-dark); color: var(--text); font-family: 'Roboto', sans-serif;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100vh; text-align: center; padding: 3vh 3vw; box-sizing: border-box; position: relative;
        }
        /* Common Box Styling */
        #pin-entry-area, #scoreboard-content {
            background-color: rgba(26, 26, 26, 0.9); padding: 30px; border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; z-index: 10; position: relative;
            width: 90%; transition: opacity 0.5s ease, visibility 0s linear 0.5s;
        }
        #pin-entry-area { max-width: 400px; }
        #scoreboard-content { max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; align-items: center; width: 95%; padding: 3vh 3vw; }

        #pin-entry-area label { display: block; color: var(--secondary); font-size: 1.2em; margin-bottom: 15px; }
        #pin-input {
             background-color: var(--bg-light); color: white; border: 1px solid var(--secondary); padding: 15px; border-radius: 8px;
             width: 100%; margin-bottom: 20px; font-size: 1.5em; text-align: center; letter-spacing: 5px;
             font-family: 'Orbitron', sans-serif; outline: none; box-sizing: border-box; appearance: textfield; -moz-appearance: textfield;
        }
        #pin-input::-webkit-inner-spin-button, #pin-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        #load-scoreboard-btn {
             background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 14px 28px;
             border-radius: 30px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
             text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 100%;
        }
        #load-scoreboard-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(0,0,0,0.4); }
        #load-scoreboard-btn:disabled { background: linear-gradient(135deg, #555, #777); cursor: not-allowed; opacity: 0.6; transform: none; }
        #pin-error-message { color: var(--danger); margin-top: 15px; font-weight: bold; min-height: 1.2em; }

        h1 {
            font-family: 'Orbitron', sans-serif; color: var(--primary); font-size: clamp(2.2em, 5vw, 4em); margin-bottom: 2vh;
            text-transform: uppercase; letter-spacing: 2px; width: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        #current-pin-display { font-size: clamp(0.8em, 1.5vw, 1em); color: rgba(255, 255, 255, 0.6); margin-bottom: 2vh; }
        #current-pin-display span { font-weight: bold; color: var(--secondary); margin-left: 5px; }

        #overlay-shot-message {
            position: fixed; top: 3vh; left: 50%; transform: translateX(-50%); z-index: 100;
            background-color: rgba(255, 102, 0, 0.85); color: white; border: 2px solid var(--primary); border-radius: 10px;
            padding: 15px 30px; font-size: clamp(1.5em, 4vw, 2.5em); font-weight: bold; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); max-width: 80%; opacity: 1; visibility: visible;
            transition: opacity 0.4s ease, visibility 0s linear 0s; display: inline-block; /* Keep display for transition */
        }

        #score-columns-container { display: flex; justify-content: space-around; width: 100%; gap: 3vw; margin-bottom: 3vh; }
        .score-column { width: 48%; list-style: none; padding: 0; margin: 0; }
        li.player-item {
            display: flex; align-items: center; font-size: clamp(1.8em, 4vw, 3em);
            padding: 12px 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.15); color: var(--text);
        }
         li.player-item:last-child { border-bottom: none; }
        /* Default Face Icon SVG */
        .default-face-icon-svg {
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ccc"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
             background-repeat: no-repeat; background-size: 70%; background-position: center;
        }
        .player-face-img, #winner-face-img {
            border-radius: 50%; background-color: var(--bg-light); background-size: cover; background-position: center;
            object-fit: cover;
        }
        .player-face-img { width: 100px; height: 100px; margin-right: 20px; flex-shrink: 0; border: 3px solid var(--secondary); display: inline-block; }
        .player-info-wrapper { display: flex; align-items: center; flex-grow: 1; overflow: hidden; min-width: 0; }
        .player-name { color: var(--secondary); text-align: left; margin-right: 20px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; }
        .player-score { font-family: 'Orbitron', sans-serif; font-weight: 700; min-width: 80px; text-align: right; color: var(--primary); flex-shrink: 0; }

        #winner-display {
            font-family: 'Orbitron', sans-serif; font-size: clamp(2.5em, 6vw, 4.5em); color: var(--success);
            margin-top: 4vh; font-weight: bold; line-height: 1.3; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 2vh;
        }
        #winner-face-img { width: clamp(150px, 25vw, 250px); height: clamp(150px, 25vw, 250px); border: 5px solid var(--success); }
        #winner-text { text-align: center; }
        #winner-name-text { display: block; margin-bottom: 5px; color: var(--success); }
        #winner-reward-text { font-size: 0.6em; font-weight: normal; color: var(--text); display: block; }

        #status-message { font-size: clamp(1.2em, 2.5vw, 1.8em); color: rgba(255, 255, 255, 0.7); width: 100%; text-align: center; padding: 20px 0; margin-top: 2vh; }

        #video-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.6s ease-in-out, visibility 0s linear 0.6s;
        }
        #video-container.visible { opacity: 1; visibility: visible; transition: opacity 0.6s ease-in-out, visibility 0s linear 0s; display: flex !important; }
        #youtube-player { width: 80vw; height: 45vw; max-width: 1280px; max-height: 720px; border: 2px solid var(--secondary); box-shadow: 0 0 30px rgba(0, 204, 255, 0.5); }

        /* Visibility/Transition Handling */
        .hidden-via-js { display: none !important; } /* Use this if NO transition needed */
        .hidden-trans { /* Use this for opacity transitions */
            opacity: 0 !important;
            visibility: hidden !important;
            transition: opacity 0.5s ease, visibility 0s linear 0.5s;
        }
        /* Apply base display for transitioning elements */
        #pin-entry-area, #scoreboard-content, #winner-display { display: flex; flex-direction: column; align-items: center; }
        #score-columns-container { display: flex; }
        #overlay-shot-message { display: inline-block; }
        #status-message, #current-pin-display, #winner-face-img { display: block; } /* Or inline-block if layout requires */

        /* Specific transition delays */
         #overlay-shot-message.hidden-trans { transition: opacity 0.4s ease, visibility 0s linear 0.4s; }
         #video-container.hidden-trans { transition: opacity 0.6s ease-in-out, visibility 0s linear 0.6s; } /* Already handled by .visible removal */
    </style>
</head>
<body>

    <div id="pin-entry-area"> <!-- Starts visible -->
        <label for="pin-input">Enter Game PIN:</label>
        <input type="number" id="pin-input" pattern="\d{4}" title="4-digit PIN" maxlength="4" inputmode="numeric">
        <button id="load-scoreboard-btn">Load Scoreboard</button>
        <div id="pin-error-message"></div>
    </div>

    <div id="overlay-shot-message" class="hidden-trans"></div> <!-- Starts hidden -->

    <div id="scoreboard-content" class="hidden-trans"> <!-- Starts hidden -->
        <h1>Hardster Scores</h1>
        <div id="current-pin-display" class="hidden-trans">Viewing PIN: <span id="viewing-pin"></span></div>

        <div id="score-columns-container" class="hidden-trans">
            <ul id="score-column-1" class="score-column"></ul>
            <ul id="score-column-2" class="score-column"></ul>
        </div>

         <div id="status-message" class="hidden-trans">Connecting...</div>

        <div id="winner-display" class="hidden-trans">
            <img id="winner-face-img" src="" alt="Winner Face" class="hidden-trans default-face-icon-svg"> <!-- Apply default icon class -->
            <div id="winner-text">
                 <span id="winner-name-text"></span>
                 <span id="winner-reward-text"></span>
            </div>
        </div>
    </div>

    <div id="video-container" class="hidden-trans"> <!-- Starts hidden -->
        <div id="youtube-player"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyD0nnCDuG_4ymWoWk5AKYaXwnl4nWkVi9s", // Replace with your config
          authDomain: "hardster-7e2c5.firebaseapp.com",
          databaseURL: "https://hardster-7e2c5-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "hardster-7e2c5",
          storageBucket: "hardster-7e2c5.appspot.com",
          messagingSenderId: "667886748380",
          appId: "1:667886748380:web:38b2c60e14158d16ae2a19",
        };
        const FIREBASE_ROOT_PATH = 'hardster/games';
        const MAX_DISPLAY_PLAYERS = 8;

        // --- DOM Elements ---
        const pinEntryArea = document.getElementById('pin-entry-area');
        const pinInput = document.getElementById('pin-input');
        const loadButton = document.getElementById('load-scoreboard-btn');
        const pinErrorMessage = document.getElementById('pin-error-message');
        const scoreboardContent = document.getElementById('scoreboard-content');
        const viewingPinEl = document.getElementById('viewing-pin');
        const currentPinDisplay = document.getElementById('current-pin-display');
        const overlayShotMessageEl = document.getElementById('overlay-shot-message');
        const scoreColumnsContainer = document.getElementById('score-columns-container');
        const scoreColumn1 = document.getElementById('score-column-1');
        const scoreColumn2 = document.getElementById('score-column-2');
        const statusMessageEl = document.getElementById('status-message');
        const winnerDisplayEl = document.getElementById('winner-display');
        const winnerNameTextEl = document.getElementById('winner-name-text');
        const winnerRewardTextEl = document.getElementById('winner-reward-text');
        const winnerFaceImgEl = document.getElementById('winner-face-img');
        const videoContainer = document.getElementById('video-container');
        // youtubePlayerDiv is implicitly 'youtube-player' via API

        // --- State ---
        let firebaseApp;
        let dbRef = null;
        let currentPIN = null;
        let listenerAttached = false;
        let youtubePlayer = null;
        let lastReceivedState = { videoId: null, show: false, isPlaying: false, shotMessage: null };
        let isVideoCurrentlyVisible = false;

        // --- Helper Functions ---
        function setElementVisibility(element, show, useTransition = true) {
            if (!element) return;
            const hiddenClass = useTransition ? 'hidden-trans' : 'hidden-via-js';
            if (show) {
                element.classList.remove(hiddenClass);
            } else {
                element.classList.add(hiddenClass);
            }
        }
        function escapeHTML(str) { return String(str ?? '').replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, '''); }
        function setFaceImage(imgElement, faceDataUrl) {
            if (!imgElement) return;
            imgElement.src = ''; // Clear src first
            imgElement.style.backgroundImage = ''; // Clear background styles
            imgElement.classList.remove('default-face-icon-svg'); // Remove default icon class

            if (faceDataUrl) {
                imgElement.src = faceDataUrl; // Use src for <img> tag
                imgElement.style.backgroundSize = 'cover'; // Ensure cover for loaded images
                imgElement.style.backgroundPosition = 'center';
            } else {
                // Apply default icon styles if no URL
                imgElement.classList.add('default-face-icon-svg');
            }
        }


        // --- Firebase Initialization ---
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized for scoreboard.");
        } catch (e) {
            console.error("Firebase init failed:", e);
            pinErrorMessage.textContent = 'Error connecting to Firebase.';
            loadButton.disabled = true;
        }

        // --- YouTube Player API ---
        function onYouTubeIframeAPIReady() { /* ... (no changes needed) ... */ }
        function onPlayerReady(event) { /* ... (no changes needed) ... */ }
        function onPlayerStateChange(event) { /* ... (no changes needed) ... */ }
        function onPlayerError(event) { /* ... (no changes needed) ... */ }
        function loadAndPlayVideo(videoId) {
            if (youtubePlayer?.loadVideoById) {
                if (lastReceivedState.videoId !== videoId || !isVideoCurrentlyVisible) {
                    console.log(`Showing container, loading video: ${videoId}`);
                    setElementVisibility(scoreboardContent, false); // Hide scoreboard
                    setElementVisibility(videoContainer, true); // Show video
                    isVideoCurrentlyVisible = true;
                    youtubePlayer.loadVideoById(videoId);
                } else { console.log("Video ID same, already visible. Syncing playback."); syncVideoPlaybackState(lastReceivedState.isPlaying); }
            } else { console.warn("YT player not ready, cannot load video."); setElementVisibility(scoreboardContent, true); hideVideo(); }
        }
         function hideVideo() {
            if (isVideoCurrentlyVisible) {
                console.log("Hiding video player.");
                setElementVisibility(videoContainer, false); // Hide video container
                isVideoCurrentlyVisible = false;
                if (youtubePlayer?.stopVideo) { setTimeout(() => { if (!isVideoCurrentlyVisible) { youtubePlayer.stopVideo(); console.log("Video stopped."); } }, 600); }
                setElementVisibility(scoreboardContent, true); // Ensure scoreboard content becomes visible again
            }
        }
        function syncVideoPlaybackState(shouldBePlaying) { /* ... (no changes needed) ... */ }

        // --- Event Listeners ---
        loadButton.addEventListener('click', handleLoadScoreboard);
        pinInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLoadScoreboard(); if (!/\d/.test(e.key) && !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) e.preventDefault(); });
        pinInput.addEventListener('input', () => { pinErrorMessage.textContent = ''; pinInput.value = pinInput.value.slice(0, 4); loadButton.disabled = pinInput.value.length !== 4; });

        // --- Core Functions ---
        function handleLoadScoreboard() {
            console.log("Load scoreboard button clicked."); // Debug log
            const enteredPin = pinInput.value.trim();
            if (!/^\d{4}$/.test(enteredPin)) { pinErrorMessage.textContent = 'Enter a 4-digit PIN.'; return; }
            // ** Crucial check: ensure Firebase is initialized **
            if (!firebaseApp) { pinErrorMessage.textContent = 'Firebase connection failed. Cannot load.'; console.error("FirebaseApp not initialized!"); return; }

            pinErrorMessage.textContent = ''; loadButton.disabled = true; loadButton.textContent = 'Loading...';
            console.log(`Attempting to load PIN: ${enteredPin}`); // Debug log

            // Detach previous listener
            if (dbRef && listenerAttached) { try { dbRef.off('value'); } catch(e){ console.warn("Error detaching previous listener:", e); } listenerAttached = false; console.log("Detached previous listener."); }

            currentPIN = enteredPin;
            try {
                 dbRef = firebase.database().ref(`${FIREBASE_ROOT_PATH}/${currentPIN}`);
                 console.log("Setting Firebase listener to:", dbRef.toString());
                 listenForUpdates(); // Attach listener

                 // Update UI
                 setElementVisibility(pinEntryArea, false);
                 setElementVisibility(scoreboardContent, true);
                 setElementVisibility(statusMessageEl, true); statusMessageEl.textContent = 'Loading scores...';
                 setElementVisibility(scoreColumnsContainer, false);
                 setElementVisibility(winnerDisplayEl, false);
                 setElementVisibility(overlayShotMessageEl, false);
                 viewingPinEl.textContent = currentPIN; setElementVisibility(currentPinDisplay, true);
                 hideVideo(); // Ensure video is hidden when loading new PIN

             } catch(e) {
                 console.error("Error setting Firebase path or attaching listener:", e);
                 pinErrorMessage.textContent = 'Error accessing game data. Check PIN?';
                 loadButton.disabled = false; loadButton.textContent = 'Load Scoreboard';
                 setElementVisibility(scoreboardContent, false); setElementVisibility(pinEntryArea, true); // Show PIN entry again
                 hideVideo();
             }
        }
        function listenForUpdates() {
            if (!dbRef) { console.error("Cannot listen for updates, dbRef is null."); return; }
            listenerAttached = true;
            console.log("Attaching Firebase listener..."); // Debug log
            dbRef.on('value', (snapshot) => {
                console.log("Firebase data received:", snapshot.val()); // Debug log
                updateDisplay(snapshot.val());
                // Reset loading button state (might have been disabled during PIN entry)
                loadButton.textContent = 'Load Scoreboard';
                loadButton.disabled = pinInput.value.length !== 4;
            }, (error) => {
                console.error("Firebase read failed:", error);
                scoreColumn1.innerHTML = ''; scoreColumn2.innerHTML = ''; // Clear scores
                setElementVisibility(winnerDisplayEl, false);
                setElementVisibility(overlayShotMessageEl, false);
                statusMessageEl.textContent = `Error loading scores for PIN ${currentPIN}. Game active/PIN correct?`;
                setElementVisibility(statusMessageEl, true);
                setElementVisibility(scoreColumnsContainer, false);
                setElementVisibility(scoreboardContent, true); // Ensure scoreboard area is visible to show error
                hideVideo();
                listenerAttached = false; // Listener failed

                // Re-enable PIN entry on error
                setElementVisibility(pinEntryArea, true);
                loadButton.disabled = false;
                setElementVisibility(scoreboardContent, false); // Hide scoreboard content on error
            });
        }
        function updateDisplay(data) {
            // Process incoming state
            const incoming = {
                videoId: data?.currentVideoId || null, show: data?.showVideo === true, isPlaying: data?.isPlaying === true,
                shotMessage: data?.shotMessage || null, isGameOver: data?.isGameOver === true,
                players: data?.players || [], winnerName: data?.winnerName || null, winnerFaceDataUrl: data?.winnerFaceDataUrl || null
            };

            // Handle Overlay Shot Message
            setElementVisibility(overlayShotMessageEl, incoming.shotMessage && !incoming.isGameOver);
            if (incoming.shotMessage && !incoming.isGameOver) overlayShotMessageEl.textContent = incoming.shotMessage;

            // Handle Video Show/Hide & Sync
            const shouldShowVideo = incoming.show && incoming.videoId && !incoming.isGameOver;
            if (shouldShowVideo) {
                if (incoming.videoId !== lastReceivedState.videoId || shouldShowVideo !== lastReceivedState.show || !isVideoCurrentlyVisible) { loadAndPlayVideo(incoming.videoId); }
                else { syncVideoPlaybackState(incoming.isPlaying); }
            } else { if (isVideoCurrentlyVisible) hideVideo(); else setElementVisibility(scoreboardContent, true); }
            if (shouldShowVideo && incoming.isPlaying !== lastReceivedState.isPlaying) { syncVideoPlaybackState(incoming.isPlaying); }

            // --- Update Scoreboard Content (Scores, Winner, Status) ---
            // This runs regardless of video state, but scoreboardContent might be hidden
            scoreColumn1.innerHTML = ''; scoreColumn2.innerHTML = ''; // Clear previous scores
            setElementVisibility(winnerDisplayEl, false); setElementVisibility(statusMessageEl, false); setElementVisibility(scoreColumnsContainer, false);

            if (!data) {
                 statusMessageEl.textContent = `Waiting for game data for PIN ${currentPIN}...`;
                 setElementVisibility(statusMessageEl, true);
            } else if (incoming.isGameOver && incoming.winnerName) {
                 // --- Display Winner Info ---
                 winnerNameTextEl.textContent = escapeHTML(incoming.winnerName);
                 const shots = (incoming.players.length >= 5 ? 2 : 1);
                 winnerRewardTextEl.textContent = `mag ${shots} shot${shots > 1 ? 's' : ''} uitdelen!`;

                 setFaceImage(winnerFaceImgEl, incoming.winnerFaceDataUrl); // Use helper to set image or default icon
                 winnerFaceImgEl.alt = `Winner: ${escapeHTML(incoming.winnerName)}`;
                 setElementVisibility(winnerFaceImgEl, true);
                 setElementVisibility(winnerDisplayEl, true);
             } else {
                 // --- Display Scores (if game not over) ---
                 if (incoming.players && incoming.players.length > 0) {
                     setElementVisibility(scoreColumnsContainer, true); // Show columns if players exist
                     incoming.players.slice(0, MAX_DISPLAY_PLAYERS).forEach((player, index) => {
                         const li = document.createElement('li'); li.className = 'player-item';

                         const faceImg = document.createElement('img'); faceImg.className = 'player-face-img';
                         setFaceImage(faceImg, player.faceDataUrl); // Use helper
                         faceImg.alt = `${escapeHTML(player.name)} face`;

                         const nameSpan = document.createElement('span'); nameSpan.className = 'player-name'; nameSpan.textContent = escapeHTML(player.name);
                         const scoreSpan = document.createElement('span'); scoreSpan.className = 'player-score'; scoreSpan.textContent = player.score;
                         const infoWrapper = document.createElement('div'); infoWrapper.className = 'player-info-wrapper'; infoWrapper.appendChild(faceImg); infoWrapper.appendChild(nameSpan);
                         li.appendChild(infoWrapper); li.appendChild(scoreSpan);

                         // Distribute players between columns
                         if (index % 2 === 0) { scoreColumn1.appendChild(li); } else { scoreColumn2.appendChild(li); }
                     });
                     // If after adding all players, both columns are still empty (e.g., MAX_DISPLAY_PLAYERS=0), show status
                     if (scoreColumn1.children.length === 0 && scoreColumn2.children.length === 0) {
                         statusMessageEl.textContent = 'No players to display...'; setElementVisibility(statusMessageEl, true); setElementVisibility(scoreColumnsContainer, false);
                     }
                 } else {
                      // No players in the data
                      statusMessageEl.textContent = 'Waiting for players...'; setElementVisibility(statusMessageEl, true); setElementVisibility(scoreColumnsContainer, false);
                 }
             }

            // Update last known state
            lastReceivedState = { ...incoming };
        } // --- End UpdateDisplay Function ---

        // Initial state
        loadButton.disabled = true;
        // Hide elements initially using CSS classes
        setElementVisibility(scoreboardContent, false);
        setElementVisibility(overlayShotMessageEl, false);
        setElementVisibility(videoContainer, false);

    </script>
</body>
</html>
